- hosts: "{{groups.compute[0]}}"
  gather_facts: no
  connection: local
  become: true
  tasks:
  - name: mkdir
    file:
      path: "{{vars.nfs_mount_path}}/OpenFOAM/install"
      state: directory
  - name: install mysql
    yum:
      name: mysql
      state: latest
  - name: wget install intelmpi openfoam8
    get_url: 
      url: https://objectstorage.us-phoenix-1.oraclecloud.com/p/96Um0TDiq3Y9CuBknloaOwaAdq6yS9XQ4h4dK3mpE6c/n/hpc/b/HPC_APPS/o/OpenFOAM-8_GCC_IMPI2019.tar
      dest: "{{vars.nfs_mount_path}}/OpenFOAM/install/OpenFOAM-8_GCC_IMPI2019.tar"
  - name: untar intelmpi openfoam8
    unarchive:
      src: "{{vars.nfs_mount_path}}/OpenFOAM/install/OpenFOAM-8_GCC_IMPI2019.tar"
      dest: "{{vars.nfs_mount_path}}/OpenFOAM/install/"
  - name: wget install openmpi openfoam7 
    get_url:
      url: https://objectstorage.us-phoenix-1.oraclecloud.com/p/f48lM3aXtcEiCGJihz-sxpH808zie7VEbBHbihuZ2YI/n/hpc/b/HPC_APPS/o/openfoam7_OL77_RDMA.tar
      dest: "{{vars.nfs_mount_path}}/OpenFOAM/install/openfoam7_OL77_RDMA.tar"
  - name: untar openmpi openfoam7
    unarchive:
      src: "{{vars.nfs_mount_path}}/OpenFOAM/install/openfoam7_OL77_RDMA.tar"
      dest: "{{vars.nfs_mount_path}}/OpenFOAM/install/"
  - name: mkdir
    file:
      path: "{{vars.nfs_mount_path}}/OpenFOAM/models"
      state: directory
  - name: wget benchmark
    get_url:
      url: https://objectstorage.us-phoenix-1.oraclecloud.com/p/V7-M6bL-HWGKNLiZ2iCiKdG3ehzs3nkjwX6_zDNEbSM/n/hpc/b/HPC_BENCHMARKS/o/motorbike_RDMA.tgz
      dest: "{{vars.nfs_mount_path}}/OpenFOAM/models/motorbike_RDMA.tgz"
  - name: untar Openfoam
    unarchive:
      src: "{{vars.nfs_mount_path}}/OpenFOAM/models/motorbike_RDMA.tgz"
      dest: "{{vars.nfs_mount_path}}/OpenFOAM/models/"
- hosts: compute
  tasks:
  - name: Add PATH line
    lineinfile:
      path: /home/opc/.bashrc
      line: export PATH=/usr/mpi/gcc/openmpi-3.1.1rc1/bin/:$PATH
      create: yes
  - name: Add LIBRARY_PATH line
    lineinfile:
      path: /home/opc/.bashrc
      line: export LD_LIBRARY_PATH=/usr/mpi/gcc/openmpi-3.1.1rc1/lib/:$LD_LIBRARY_PATH
      create: yes
  - name: Add source line
    lineinfile:
      path: /home/opc/.bashrc
      line: "source {{vars.nfs_mount_path}}/OpenFOAM/install/OpenFOAM/OpenFOAM-7/etc/bashrc"
      create: yes
  - name: Add hostname to hostfile
    lineinfile:
      path: "{{vars.nfs_mount_path}}/OpenFOAM/models/hostfile"
      line: "{{ansible_host}} cpu=36"
      create: yes
